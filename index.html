<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MateTap Deluxe ğŸ§‰</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body,html{margin:0;padding:0;width:100%;height:100%;overflow:hidden;font-family:Arial,sans-serif;}
#bgCanvas{position:absolute;top:0;left:0;width:100%;height:100%;z-index:-1;}
h1,h2,h3{margin:5px;text-shadow:0 0 20px #22c55e;}
#mate{width:180px;margin-top:30px;cursor:pointer;transition: transform 0.1s;}
#mate:active{transform: scale(1.2) rotate(-15deg);}
#points{font-size:50px;margin:10px;font-weight:bold;color:#22c55e;text-shadow:0 0 15px #000;}
.floating{position:absolute;font-weight:bold;font-size:20px;animation: floatUp 1s ease-out forwards;}
@keyframes floatUp{0%{opacity:1;transform:translateY(0) scale(1);}50%{transform:translateY(-40px) scale(1.2);}100%{opacity:0;transform:translateY(-80px) scale(1);}}
.powerup{position:absolute;font-size:35px;cursor:pointer;animation: floatUp 1.2s ease-out forwards;}
.badge{position:absolute;font-size:25px;font-weight:bold;color:gold;animation: floatUp 2s ease-out forwards;}
#ranking{margin:20px auto;background:rgba(0,0,0,0.5);padding:15px;border-radius:10px;max-width:350px;color:white;}
.player{display:flex;justify-content:space-between;margin:5px 0;}
#skinsMenu button{padding:5px 10px;border:none;border-radius:5px;cursor:pointer;background:rgba(255,255,255,0.2);color:white;margin:3px;}
#skinsMenu button:disabled{opacity:0.5;cursor:not-allowed;}
</style>
</head>

<body>
<canvas id="bgCanvas"></canvas>

<h1 id="points">0 ğŸ§‰</h1>
<img id="mate" src="https://i.imgur.com/7QF5Y6H.png">
<audio id="clickSound" src="https://assets.mixkit.co/sfx/preview/mixkit-game-click-1114.mp3"></audio>
<audio id="levelSound" src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.wav"></audio>
<audio id="powerupSound" src="https://assets.mixkit.co/sfx/preview/mixkit-magic-chime-2.mp3"></audio>
<audio id="badgeSound" src="https://assets.mixkit.co/sfx/preview/mixkit-fantasy-bonus-530.wav"></audio>

<div id="ranking">
<h2>ğŸ† Top 10 Ranking</h2>
<div id="rankingList"></div>
</div>

<h3>ğŸ’° Monedas: <span id="coins">0</span></h3>
<h3>ğŸ¨ Skins</h3>
<div id="skinsMenu"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// ğŸ”¹ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyB76iQtr2i3hG6TIgIpdn3W6rdaxMK9wFQ",
  authDomain: "matetap-e96c3.firebaseapp.com",
  projectId: "matetap-e96c3",
  storageBucket: "matetap-e96c3.firebasestorage.app",
  messagingSenderId: "894538866852",
  appId: "1:894538866852:web:ac59889ebf0ec4d0bf0631"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ğŸ”¹ Telegram
Telegram.WebApp.ready();

// ğŸ”¹ DOM
const mate=document.getElementById("mate");
const pointsText=document.getElementById("points");
const coinsText=document.getElementById("coins");
const rankingList=document.getElementById("rankingList");
const skinsMenu=document.getElementById("skinsMenu");
const clickSound=document.getElementById("clickSound");
const levelSound=document.getElementById("levelSound");
const powerupSound=document.getElementById("powerupSound");
const badgeSound=document.getElementById("badgeSound");

// ğŸ”¹ User
const username=Telegram.WebApp.initDataUnsafe.user?.username||"Anon";

// ğŸ”¹ Skins
const skins=[
  {name:"Default", src:"https://i.imgur.com/7QF5Y6H.png", cost:0},
  {name:"Fuego", src:"https://i.imgur.com/f9a1XQm.png", cost:20},
  {name:"Hielo", src:"https://i.imgur.com/J8l5P4u.png", cost:50},
  {name:"Neon", src:"https://i.imgur.com/BmC47fo.png", cost:100}
];
let unlocked=JSON.parse(localStorage.getItem("skinsUnlocked")||'["Default"]');
let activeSkin=localStorage.getItem("activeSkin")||"Default";

// ğŸ”¹ State
let points=0, coins=0;

// ğŸ”¹ Fondo animado con partÃ­culas
const canvas=document.getElementById("bgCanvas");
const ctx=canvas.getContext("2d");
canvas.width=window.innerWidth; canvas.height=window.innerHeight;
let particles=[];
for(let i=0;i<150;i++){particles.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,r:Math.random()*4+1,dx:(Math.random()-0.5)*1.5,dy:(Math.random()-0.5)*1.5})}
function drawParticles(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  particles.forEach(p=>{
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.r,0,2*Math.PI);
    ctx.fillStyle="rgba(34,197,94,0.5)";
    ctx.fill();
    p.x+=p.dx; p.y+=p.dy;
    if(p.x>canvas.width)p.x=0;if(p.x<0)p.x=canvas.width;
    if(p.y>canvas.height)p.y=0;if(p.y<0)p.y=canvas.height;
  });
  requestAnimationFrame(drawParticles);
}
drawParticles();
window.addEventListener("resize",()=>{canvas.width=window.innerWidth;canvas.height=window.innerHeight});

// ğŸ”¹ Load user
async function loadUser(){
  const userDoc=doc(db,"users",username);
  const snapshot=await getDoc(userDoc);
  if(snapshot.exists()){
    const data=snapshot.data();
    points=data.points||0;
    coins=data.coins||0;
    unlocked=data.unlocked||unlocked;
    activeSkin=data.activeSkin||activeSkin;
  }
  pointsText.innerText=points+" ğŸ§‰";
  coinsText.innerText=coins;
  mate.src=skins.find(s=>s.name===activeSkin).src;
  updateSkinsMenu();
}

// ğŸ”¹ Save user
async function saveUser(){
  const userDoc=doc(db,"users",username);
  await setDoc(userDoc,{points,coins,unlocked,activeSkin,updatedAt:Date.now()});
}

// ğŸ”¹ Skins menu
function updateSkinsMenu(){
  skinsMenu.innerHTML="";
  skins.forEach(skin=>{
    const btn=document.createElement("button");
    btn.innerText=skin.name+(unlocked.includes(skin.name)?" âœ…":" ğŸ’°"+skin.cost);
    btn.disabled=!unlocked.includes(skin.name) && coins<skin.cost;
    btn.onclick=()=>{
      if(!unlocked.includes(skin.name)){
        if(coins>=skin.cost){coins-=skin.cost; unlocked.push(skin.name);}
        else{alert("No tienes suficientes monedas ğŸ’°");return;}
      }
      activeSkin=skin.name;
      mate.src=skin.src;
      localStorage.setItem("activeSkin",activeSkin);
      localStorage.setItem("skinsUnlocked",JSON.stringify(unlocked));
      updateSkinsMenu();
      saveUser();
    };
    skinsMenu.appendChild(btn);
  });
}

// ğŸ”¹ Floating points
function spawnFloating(e){
  const plus=document.createElement("div");
  plus.classList.add("floating");
  plus.innerText="+1 ğŸ§‰";
  plus.style.left=e.pageX+"px"; plus.style.top=e.pageY+"px";
  document.body.appendChild(plus);
  setTimeout(()=>plus.remove(),1200);
}

// ğŸ”¹ Click event
mate.addEventListener("click",(e)=>{
  points++; pointsText.innerText=points+" ğŸ§‰"; clickSound.currentTime=0; clickSound.play();
  spawnFloating(e);
  if(points%10===0){coins++; coinsText.innerText=coins; powerupSound.play();}
  if(points%50===0){badgeSound.play();}
  saveUser();
});

// ğŸ”¹ Leaderboard
async function loadRanking(){
  const q=query(collection(db,"leaderboard"),orderBy("score","desc"),limit(10));
  const snapshot=await getDocs(q);
  rankingList.innerHTML="";
  snapshot.forEach(doc=>{
    const data=doc.data();
    rankingList.innerHTML+=`<div class="player"><span>${data.name}</span><span>${data.score} ğŸ§‰</span></div>`;
  });
}

// ğŸ”¹ Auto-save score
async function saveScore(){
  await addDoc(collection(db,"leaderboard"),{name:username,score:points,coins,createdAt:Date.now()});
  loadRanking();
}

// ğŸ”¹ Inicializar
loadUser(); loadRanking();
setInterval(saveScore,15000);

</script>
</body>
</html>
